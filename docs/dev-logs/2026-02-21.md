# Dev Log — 2026-02-21

## Zmeny dnes

Hlavna zmena: oprava Kosice votes pipeline + podpora starsich sezon (2018-2022).

### polls-api (1 commit)

#### 1. `Meeting.isComplete()` — meeting bez polls = nekompletny
- **Predtym:** `if (!hasPolls()) return true` — meeting bez hlasovani bol oznaceny ako "complete"
- **Teraz:** `if (!hasPolls()) return false` — nuti re-sync kym sa polls nenacitaju
- `getIncompleteReason()` teraz vracia "no polls" namiesto null

#### 2. `syncRetryCount` — ochrana proti nekonecnemu re-loadu
- Novy field `Meeting.syncRetryCount` (integer default 0)
- `MeetingSyncService`: po 2 neuspesnych pokusoch nastavi `syncError = "No polls available after N retries"`
- Retry count sa zachovava cez delete+re-insert (existujuci count + 1)

#### 3. `KosiceWebImport.memberSlugToName` — populate z DB pri restarte
- Inject `CouncilMemberRepository`
- Nova metoda `ensureMemberSlugToNameLoaded()` naplni cache z DB ak je prazdna
- Per-sezona tracking (`currentSeasonRef`) — reset cache pri zmene sezony
- **Rieseny problem:** po restarte servera bola `memberSlugToName` null → votes sa nevytvárali

#### 4. `extPollRouteId` na Kosice polls
- Chybal `poll.setExtPollRouteId()` v `buildPollsFromMemberVotes()`
- Bez neho `MeetingSyncService:175` preskocil `loadPollDetails()` → votes nemali pripojene CouncilMembers
- Pridany: `"kosice-vote:" + meetingId + ":" + voteNumber`

#### 5. Legacy member scraper pre starsie Kosice sezony
- Nova metoda `scrapeMembersLegacy()` v `KosiceScraper`
- Fallback ak `div.membership` vrati 0 vysledkov
- Parsuje `<strong>` (club names) + `<a href=static.kosice.sk>` (member links)
- Members bez detailov (photo, email) — len meno + klub
- 2018-2022 stranka ma 41 members v 4 kluboch (FUNGUJUCE KOSICE, KOSICKI AKTIVISTI A NEZAVISLI, PRE KOSICANOV, NEZARADENI)

#### 6. Member sync pri season discovery
- `SeasonDiscoveryService` teraz vola `councilMemberSyncService.syncCouncilMembers()` **pred** `syncSeasonMeetings()`
- **Predtym:** "Najdi starsie" nacitalo meetings ale 0 members → votes sa nedali matchovat

#### 7. PDF attachments z Kosice meeting pages
- `scrapeMeetingDetails()` teraz extrahuje PDF linky (`a[href*=static.kosice.sk][href$=.pdf]`)
- Uklada ako `MeetingAttachment` s menom a URL
- `MeetingSyncService.findVotingPdfUrl()` ich najde cez filter `name.contains("hlasovan")`
- Starsie meetings (2018-2022) maju voting PDF-ka (napr. "Hlasovanie c. 1-20 dna 08.09.2022")

#### 8. Cleanup MeetingSyncService logiky
- `existing.isComplete() && existing.hasPolls()` zjednoduseny na `existing.isComplete()` (kedze isComplete uz vyzaduje polls)
- `existing.isComplete() && !existing.hasPolls()` nahradeny `!existing.hasPolls()` (unreachable branch po zmene)

## Subory zmenene

| Subor | Riadkov +/- | Co |
|-------|------------|-----|
| `Meeting.java` | +19/-2 | syncRetryCount, isComplete() fix |
| `MeetingSyncService.java` | +13/-3 | retry protection, simplified branches |
| `SeasonDiscoveryService.java` | +8/-1 | member sync pri discovery |
| `KosiceScraper.java` | +98 | legacy scraper, PDF extraction, extPollRouteId |
| `KosiceWebImport.java` | +41/-2 | DB cache, per-season tracking |

## Ocakavany efekt

### Kosice 2022-2026 (existujuca sezona)
- Members: 41 (uz existuju)
- Meetings: 35 (uz existuju, ale bez polls → teraz sa budu re-syncovat)
- Votes: mali by sa nacitat cez member profile scraping + loadPollDetails matching

### Kosice 2018-2022 (nova sezona cez "Najdi starsie")
- Members: ~41 (legacy scraper, len meno + klub, bez foto/email)
- Meetings: 37 (uz existuju v DB, ale syncComplete=true → po zmene isComplete() sa budu re-syncovat)
- Votes: z voting PDF-iek (fallback cez DMPdfImporter)

## TODO na dalsiu iteraciu
1. **Deploy na Railway** a overit v logoch ci sa votes nacitali
2. **Verify 2022-2026 votes** — ci buildPollsFromMemberVotes + loadPollDetails matchuju spravne
3. **Verify 2018-2022 PDF fallback** — ci DMPdfImporter spracuje Kosice PDF format
4. **Trnava enrichment** — 26/57 members bez match (name matching issue)
5. **Nitra meetings** — scraper pre zoznam zasadnuti
